// import React from 'react'

// export const InviteTable = () => {
//   return (

// <div className='px-20 py-20 '>
//     <div>
//     <h1 className="py-5 text-xl leading-tight font-bold text-gray-500">
//         Invites
//     </h1>
//     </div>
// <div className="overflow-x-auto shadow-md sm:rounded-lg overflow-y-scroll h-64 ">
//     <table className="w-full  text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">

//         <tbody className="">
//             <tr className="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700">
//                 <th scope="row" className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
//                     samanj@99x.com
//                 </th>
//                 <td className="px-6 py-4">
//                     Developer
//                 </td>
//                 <td className="px-6 py-4">
//                     Laptop
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">resend</a>
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">Delete</a>
//                 </td>
//             </tr>
//             <tr className="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700">
//                 <th scope="row" className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
//                     sandunn@99x.com
//                 </th>
//                 <td className="px-6 py-4">
//                     QAE
//                 </td>
//                 <td className="px-6 py-4">
//                     Laptop
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">resend</a>
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">Delete</a>
//                 </td>
//             </tr>
//             <tr className="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700">
//                 <th scope="row" className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
//                     deshitha@99x.com
//                 </th>
//                 <td className="px-6 py-4">
//                     Developer
//                 </td>
//                 <td className="px-6 py-4">
//                     Laptop
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">resend</a>
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">Delete</a>
//                 </td>
//             </tr>
//             <tr className="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700">
//                 <th scope="row" className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
//                     Anushas@99x.com
//                 </th>
//                 <td className="px-6 py-4">
//                     Developer
//                 </td>
//                 <td className="px-6 py-4">
//                     Laptop
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">resend</a>
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">Delete</a>
//                 </td>
//             </tr>
//             <tr>
//             <th scope="row" className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
//                     hansajith@99x.com
//                 </th>
//                 <td className="px-6 py-4">
//                     QAE
//                 </td>
//                 <td className="px-6 py-4">
//                     Laptop
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">resend</a>
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">Delete</a>
//                 </td>
//             </tr>
//             <tr className="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700">
//             <th scope="row" className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
//                     lakshitha@99x.com
//                 </th>
//                 <td className="px-6 py-4">
//                     Developer
//                 </td>
//                 <td className="px-6 py-4">
//                     Laptop
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">resend</a>
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">Delete</a>
//                 </td>
//             </tr>
//             <tr>
//             <th scope="row" className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
//                     nandun@99x.com
//                 </th>
//                 <td className="px-6 py-4">
//                     Developer
//                 </td>
//                 <td className="px-6 py-4">
//                     Laptop
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">resend</a>
//                 </td>
//                 <td className="px-6 py-4">
//                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">Delete</a>
//                 </td>
//             </tr>

//         </tbody>
//     </table>
// </div>

// </div>

//   )
// }

////////////////////

// import React, { useState, useEffect } from 'react';

// export const InviteTable = () => {
//     const [invites, setInvites] = useState([]);

//     useEffect(() => {
//         fetchInviteTable();
//     }, []);

//     const fetchInviteTable = async () => {
//         try {
//             const response = await fetch('http://127.0.0.1:8000/invite-table');
//             const data = await response.json();
//             setInvites(data);
//         } catch (error) {
//             console.error('Error fetching invite table:', error);
//         }
//     };

//     return (
//         <div className='px-20 py-20 '>
//             <div>
//                 <h1 className="py-5 text-xl leading-tight font-bold text-gray-500">
//                     Invites
//                 </h1>
//             </div>
//             <div className="overflow-x-auto shadow-md sm:rounded-lg overflow-y-scroll h-64">
//                 <table className="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">

//                     <tbody className="">
//                         {invites.map((invite, index) => (
//                             <tr key={index} className={index % 2 === 0 ? 'even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700' : 'odd:bg-white odd:dark:bg-gray-900 border-b dark:border-gray-700'}>
//                                 <td scope="row" className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
//                                     {invite.email}
//                                 </td>
//                                 <td className="px-6 py-4">
//                                     {invite.role}
//                                 </td>
//                                 <td className="px-6 py-4">
//                                     {invite.device}
//                                 </td>
//                                 <td className="px-6 py-4">
//                                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">Resend</a>
//                                 </td>
//                                 <td className="px-6 py-4">
//                                     <a href="#" className="font-medium text-blue-600 dark:text-blue-500 hover:underline">Delete</a>
//                                 </td>
//                             </tr>
//                         ))}
//                     </tbody>
//                 </table>
//             </div>
//         </div>
//     );
// };

import React, { useRef,useState, useEffect } from "react";
import axios from "axios";
import {
  Modal,
  ModalOverlay,
  ModalContent,
  ModalHeader,
  ModalFooter,
  ModalBody,
  ModalCloseButton,
  FormControl,
  FormLabel,
  useDisclosure
} from '@chakra-ui/react';
import { Select } from '@chakra-ui/react';
import { Input, InputGroup, InputLeftElement, InputRightAddon} from '@chakra-ui/react';
import { Search2Icon } from "@chakra-ui/icons";
import { Button, ButtonGroup } from '@chakra-ui/react';
import emailjs from "@emailjs/browser"


export const InviteTable = () => {
  const { isOpen: isOpen1, onOpen: onOpen1, onClose: onClose1 } = useDisclosure(); // Rename variables for the first modal
  const { isOpen: isOpen2, onOpen: onOpen2, onClose: onClose2 } = useDisclosure(); 
  const initialRef = React.useRef(null)
  const finalRef = React.useRef(null)
  const [invites, setInvites] = useState([]);
  const [error, setError] = useState(null);
  const [index, setIndex] = useState(null);
  const [email, setEmail] = useState("");
  const [role, setRole] = useState("");
  const emailRef = useRef("");
  const roleRef = useRef("");
  const [loading, setLoading] = useState(false);
  
  
  useEffect(() => {
    const fetchInviteTable = async () => {
      try {
        const response = await axios.get("http://127.0.0.1:8001/invite-table");
        setInvites(response.data);
      } catch (error) {
        console.error("Error fetching invite table:", error);
        setError("Error fetching invite table. Please try again later.");
      }
    };
    
    fetchInviteTable();
  }, []);

  useEffect(() => emailjs.init("PS5ghhKYxM1wwF0sO"), []);
  const handleSubmit = async (e) => {
    e.preventDefault();
    const serviceId = "service_pst9db1";
    const templateId = "template_bq195h8";
    try {
      debugger
      await emailjs.send(serviceId, templateId, {
        rolef: role,
        recipient: email
      });
      alert("Email successfully sent");
    } catch (error) {
      console.error("Error sending email:", error);
      alert("Error sending email. Please try again later.");
    }
  };
  
  const handleDelete = async () => {
    try {
      // Assuming there's an API endpoint for deleting invites
      await axios.delete(`http://127.0.0.1:8001/invites/${invites[index].id}`);
      // Update invites state by removing the deleted invite
      setInvites(invites.filter(inv => inv.id != invites[index].id));
      onClose1();
    } catch (error) {
      console.error("Error deleting invite:", error);
      setError("Error deleting invite. Please try again later.");
    }
  };

  const onOpenModal = (index) => {
    setIndex(index);
    onOpen1();
  }

  const handleAddInvite = async () => {
    // Set email for emailRef
    // if (emailRef.current) {
    //   emailRef.current.value = email;
    //   console.log("Email value set:", emailRef.current.value);
    // }
    
    // // Set role for nameRef
    // if (roleRef.current) {
    //   roleRef.current.value = role;
    //   console.log("Role value set:", roleRef.current.value);
    
    try {
      await axios.post("http://127.0.0.1:8001/add-invite", { email, role });
      onClose2();
      
      
    
    // Then fetch the updated invite data
      
      // Reload invite table or fetch new data
    } catch (error) {
      console.error("Error adding invite:", error);
      // Handle error
    }};

  const handleResend = async (index) => {
    try {
      // Assuming there's an API endpoint for resending invites
      
      // Assuming the invite is updated with a new status or resent
      // You may want to fetch the updated invite after resending
      await emailjs.send("service_pst9db1", "template_bq195h8", {
        rolef: invites[index].role,
        recipient: invites[index].email
      });
      alert("Email successfully resent");
    } catch (error) {
      console.error("Error resending invite:", error);
      setError("Error resending invite. Please try again later.");
    }
  };

  
    


  return (
    <div className="px-20 py-20">
      
  
  <Modal isOpen={isOpen1} onClose={onClose1}>
    <ModalOverlay />
    <ModalContent>
      <ModalHeader>Delete Invitation</ModalHeader>
      <ModalCloseButton />
      <ModalBody>
        Do you realy want to delete the Invitation?
      </ModalBody>

      <ModalFooter>
        <Button colorScheme='blue' mr={3} onClick={() => handleDelete()}>
          Yes
        </Button>
        <Button variant='ghost' onClick={onClose1}>Close</Button>
      </ModalFooter>
    </ModalContent>
  </Modal>

  <Modal
        // initialFocusRef={initialRef}
        // finalFocusRef={finalRef}
        isOpen={isOpen2}
        onClose={onClose2}
      >
        <ModalOverlay />
        <ModalContent>
          <ModalHeader>Send Invite</ModalHeader>
          <ModalCloseButton />
          <ModalBody pb={6}>
            <FormControl>
              <FormLabel>Email</FormLabel>
              <Input
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                type="email"
                placeholder="Enter email"
              />
            </FormControl>

            <FormControl mt={4}>
              <FormLabel>Role</FormLabel>
              <Select
                value={role}
                onChange={(e) => setRole(e.target.value)}
                placeholder="Select role"
              >
                <option value="admin">Admin</option>
                <option value="user">User</option>
              </Select>
            </FormControl>
          </ModalBody>

          <ModalFooter>
            <Button colorScheme="blue" mr={3} onClick={handleAddInvite}>
              Send
            </Button>
            <Button onClick={handleSubmit}>Send Email</Button>
            <Button onClick={onClose2}>Cancel</Button>
          </ModalFooter>
        </ModalContent>
      </Modal>
      
      <div>
        <h1 className="py-5 text-xl leading-tight font-bold text-gray-500">
          Invites
        </h1>
      </div>
      <div className='flex flex-row space-x-5 py-5'>
            
            <div className='basis-2/4'>
            <InputGroup>
            <InputLeftElement children={<Search2Icon color="gray.600"/>} />
            <Input
                placeholder="Search..."
                />
          
            </InputGroup>
            </div>
            <div className='basis-1/4'>
            <Button className='w-full' colorScheme='blue' variant='outline' >Search</Button>
            </div>
            <div className='basis-1/4'>
            <Button onClick = {onOpen2} className='w-full' colorScheme='blue'>Send Invte</Button>
            </div>
           </div> 

      
      <div className="overflow-x-auto shadow-md sm:rounded-lg overflow-y-scroll h-64">
        <table className="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
          
          <tbody>
            {invites.map((invite, index) => (
              <tr
                key={index}
                className={
                  index % 2 === 0
                    ? "even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700"
                    : "odd:bg-white odd:dark:bg-gray-900 border-b dark:border-gray-700"
                }
              >
                <td className="px-6 py-4 whitespace-nowrap dark:text-white">
                  {invite.email}
                </td>
                <td className="px-6 py-4">{invite.role}</td>
                <td className="px-6 py-4">{invite.device}</td>
                <td className="px-6 py-4">
                <div className="flex justify-end space-x-2">
                <button
                    onClick={() => onOpenModal(index)}
                    className="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600"
                >
                    Delete
                </button>
                <button
                    onClick={() => handleResend(index, invite.email, invite.role)}
                    className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"
                >
                    Resend
                </button>
                </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      {error && (
        <div className="mt-4 text-red-500 dark:text-red-400">{error}</div>
      )}
    </div>
  );
};
